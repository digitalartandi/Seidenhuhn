<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>H√ºhnerhof‚ÄëH√ºpfer</title>
<link rel="manifest" href="manifest.webmanifest"/>
<meta name="theme-color" content="#c5e1a5"/>
<style>
  :root{ --ink:#1d2b1d; --brand:#43a047; --bg:#e8f5e9; --glass:rgba(255,255,255,.9); }
  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html, body{ height:100%; margin:0; background:var(--bg); color:#1b2a1b; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  #app{ position:fixed; inset:0; display:grid; grid-template-rows:auto 1fr auto; }

  /* Header: minimal */
  header{ display:flex; justify-content:space-between; align-items:center; padding:.28rem .5rem; }
  #scorePill{ background:var(--glass); border:2px solid #cde9d1; border-radius:14px; padding:.12rem .48rem; font-weight:800; font-size:clamp(.9rem,2.7vw,1rem); }
  .actions{ display:flex; gap:.35rem; }
  .iconbtn{ border:none; border-radius:12px; background:#fff; border:2px solid #d7efe0; box-shadow:0 3px 0 #c7e5d3; width:40px; height:40px; font-size:1.1rem; }

  /* Play area */
  #playArea{ position:relative; overflow:hidden; display:grid; place-items:center; padding:.25rem .5rem; }
  .canvasFrame{ position:relative; width:100%; height:100%; display:grid; place-items:center; }
  canvas{ display:block; max-width:100%; max-height:100%; touch-action:none;
          background:linear-gradient(180deg,#f8fff9 0%, #eef7f0 60%, #e6f4ec 100%); border:3px solid #bfe0c7; border-radius:12px; }

  /* Wood nav */
  #uiBar{ position:relative; border-top:2px solid #caa27a; background:url('wood.webp') center/cover no-repeat; display:grid; place-items:center; padding:.2rem 0 env(safe-area-inset-bottom); }
  .pad{ display:grid; grid-template-columns:60px 60px 60px; grid-template-rows:60px 60px 60px; gap:.22rem; }
  .pad .empty{ visibility:hidden; }
  .pad button{ width:60px; height:60px; border-radius:12px; border:none; background:#fff; border:2px solid #d7efe0; box-shadow:0 3px 0 #c7e5d3; font-size:1.2rem; }

  /* Start overlay */
  #startFS{ position:fixed; inset:0; z-index:50; display:flex; align-items:flex-end; justify-content:center; background:#000; }
  #startFS::before{ content:''; position:absolute; inset:0; background:url('cover.webp') center/cover no-repeat; opacity:.9; }
  .startBar{ position:relative; margin:0 0 calc(1rem + env(safe-area-inset-bottom)); z-index:2; }
  #playBtn{ padding:1rem 2.2rem; font-size:1.35rem; border:none; border-radius:20px; background:linear-gradient(180deg,#ffea7a 0%, #ffb44c 60%, #ff7043 100%); color:#2b190e; box-shadow:0 10px 0 #d85d37; font-weight:900; }
  #playBtn:active{ transform:translateY(2px); box-shadow:0 6px 0 #d85d37; }

  /* Game over overlay */
  #over{ position:fixed; inset:0; z-index:60; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); }
  #over .card{ background:#fff; color:#1b2a1b; border-radius:18px; padding:1rem 1.2rem; width:min(92vw,460px); box-shadow:0 30px 80px rgba(0,0,0,.2); text-align:center; }
  #over h3{ margin:.2rem 0 .6rem; }
  .row{ display:flex; gap:.6rem; justify-content:center; flex-wrap:wrap; }
  .btn{ padding:.7rem 1.1rem; border-radius:12px; border:2px solid #cde9d1; background:#f8fffb; font-weight:700; }
  .btn.primary{ background:#43a047; border-color:#2e7d32; color:#fff; }
  .btn.ghost{ background:#fff; }

  /* Accessibility focus */
  button:focus-visible{ outline:3px solid #8bc34a; outline-offset:2px; }
</style>
</head>
<body>
<div id="app">
  <header>
    <div id="scorePill">P: <span id="score">0</span></div>
    <div class="actions">
      <button id="soundBtn" class="iconbtn" title="Sound an/aus" aria-label="Sound umschalten">üîä</button>
      <button id="restartBtn" class="iconbtn" title="Neu starten" aria-label="Neu starten">üîÑ</button>
    </div>
  </header>

  <section id="playArea">
    <div class="canvasFrame">
      <canvas id="game" width="720" height="1280" aria-label="Seidenhuhn sammelt K√∂rner und W√ºrmer"></canvas>
    </div>
  </section>

  <div id="uiBar">
    <div class="pad" id="pad" aria-label="Richtungstasten">
      <div class="empty"></div><button data-d="0,-1">‚¨ÜÔ∏è</button><div class="empty"></div>
      <button data-d="-1,0">‚¨ÖÔ∏è</button><div class="empty"></div><button data-d="1,0">‚û°Ô∏è</button>
      <div class="empty"></div><button data-d="0,1">‚¨áÔ∏è</button><div class="empty"></div>
    </div>
  </div>
</div>

<div id="startFS" aria-modal="true" role="dialog">
  <div class="startBar">
    <button id="playBtn" aria-label="Spiel starten">Starten</button>
  </div>
</div>

<div id="over" aria-modal="true" role="dialog">
  <div class="card">
    <h3>Spiel vorbei üí´</h3>
    <p><strong>Punkte:</strong> <span id="fScore">0</span> ¬∑ <strong>Highscore:</strong> <span id="fHi">0</span></p>
    <div class="row">
      <button class="btn primary" id="again">üîÅ Nochmal</button>
      <button class="btn ghost" id="menu">üèÅ Start</button>
    </div>
  </div>
</div>

<script>
(function(){ 'use strict';
  // ------- Audio (aus Repo) -------
  const music = new Audio('./Introsong.mp3'); music.loop = true; music.volume = 0.55;
  const cornSfx = new Audio('./Corn.mp3'); cornSfx.volume = 0.9;
  const hen1Sfx = new Audio('./Huhn1.mp3'); hen1Sfx.volume = 0.9;
  const hen2Sfx = new Audio('./Huhn2.mp3'); hen2Sfx.volume = 0.9;
  let soundOn = true;
  let nextWorm = 0; // alternates worm sfx between corn and hen1

  function playHen2(){ if(!soundOn) return; try{ hen2Sfx.currentTime=0; hen2Sfx.play(); }catch(e){} }
  function playWormAlt(){ if(!soundOn) return; try{ const s = (nextWorm===0?cornSfx:hen1Sfx); nextWorm=1-nextWorm; s.currentTime=0; s.play(); }catch(e){} }
  function playCorn(){ if(!soundOn) return; try{ cornSfx.currentTime=0; cornSfx.play(); }catch(e){} }

  // ------- Canvas / Game -------
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d', {alpha:false});
  const playArea = document.getElementById('playArea');
  const frame = document.querySelector('.canvasFrame');

  function sizeCanvas(pxW, pxH){
    canvas.style.width = pxW + 'px';
    canvas.style.height = pxH + 'px';
    canvas.width = Math.round(pxW * dpr);
    canvas.height = Math.round(pxH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  function innerSize(el){ const cs=getComputedStyle(el); return { w: el.clientWidth - parseFloat(cs.paddingLeft) - parseFloat(cs.paddingRight), h: el.clientHeight - parseFloat(cs.paddingTop) - parseFloat(cs.paddingBottom) }; }
  function fit(){
    const s = innerSize(playArea);
    const ratio = 9/16; // portrait board ratio-ish
    let w = Math.min(s.w, 720), h = Math.min(s.h, s.w/ratio);
    if (h > s.h) { h = s.h; w = h*ratio; }
    sizeCanvas(w, h);
    const g = Math.floor(Math.min(w/18, h/26)); // grid size
    state.grid = g; state.cols = Math.floor(w/g)-2; state.rows = Math.floor(h/g)-2;
    if(state.cols<12) state.cols=12; if(state.rows<18) state.rows=18;
  }

  const state = {
    grid: 36, cols: 18, rows: 26,
    hen: {x:4,y:10}, prevHen: {x:4,y:10},
    dir: {x:1,y:0}, next: {x:1,y:0},
    items: [], // {x,y,type:'grain'|'worm'|'gold'}
    score: 0, level: 1,
    speed: 3.0,
    last: 0, mover: 0, running: false,
    hi: parseInt(localStorage.getItem('hh_hi')||'0',10)
  };
  document.getElementById('score').textContent = state.score;

  const wormImg = new Image(); wormImg.src = 'worm.webp';
  const henImg  = new Image(); henImg.src  = 'hen.webp';

  function reset(){
    state.hen={x:4,y:10}; state.prevHen={x:4,y:10};
    state.dir={x:1,y:0}; state.next={x:1,y:0};
    state.items=new Array(6).fill(0).map(()=>spawnItem());
    state.score=0; state.level=1; state.speed=3.0; state.last=0; state.mover=0;
    document.getElementById('score').textContent=state.score;
  }

  function spawnItem(){
    const r=Math.random(); const type = r<0.88?'grain':(r<0.98?'worm':'gold');
    let x,y,tries=0; do{
      x=Math.floor(Math.random()*state.cols);
      y=Math.floor(Math.random()*state.rows);
      tries++; if(tries>300) break;
    }while((x===state.hen.x && y===state.hen.y) || state.items.some(i=>i && i.x===x && i.y===y));
    return {x,y,type};
  }

  function setDir(x,y){
    if(x===-state.dir.x && y===-state.dir.y) return;
    state.next={x,y};
  }

  function advanceCell(){
    state.prevHen = {x: state.hen.x, y: state.hen.y};
    state.dir = state.next;
    const nx = state.hen.x + state.dir.x;
    const ny = state.hen.y + state.dir.y;
    if(nx<0 || ny<0 || nx>=state.cols || ny>=state.rows){ gameOver(); return false; }
    state.hen = {x:nx, y:ny};
    for(let i=0;i<state.items.length;i++){ const it=state.items[i];
      if(it && it.x===nx && it.y===ny){
        let add=10; if(it.type==='worm') add=50; if(it.type==='gold') add=50;
        state.score+=add; document.getElementById('score').textContent=state.score;
        /* SFX-Regeln: Korn => Huhn2, Wurm => Corn/Huhn1 im Wechsel */
        if(it.type==='grain'){ playHen2(); }
        else if(it.type==='worm'){ playWormAlt(); }
        else { playCorn(); }
        if(state.score>state.hi){ state.hi=state.score; localStorage.setItem('hh_hi', String(state.hi)); }
        if(state.score%50===0){ state.level++; state.speed = Math.min(8, state.speed + 0.25); }
        state.items[i]=spawnItem();
      }
    }
    return true;
  }

  function drawItem(it){
    const g=state.grid; if(!g) return;
    const x=(it.x+1)*g, y=(it.y+1)*g;
    ctx.fillStyle= it.type==='grain'?'#f6b21a':(it.type==='worm'?'#6b4a29':'#d0a800');
    if(it.type==='worm') ctx.drawImage(wormImg,x-8,y-8,16,16);
    else{ ctx.beginPath(); ctx.ellipse(x,y,6,4,0,0,Math.PI*2); ctx.fill(); }
  }

  function draw(interp){
    const g=state.grid; if(!g) return;
    ctx.fillStyle='#f3fbf5'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle='rgba(120,170,135,.22)'; ctx.lineWidth=1;
    for(let x=0;x<=state.cols;x++){ ctx.beginPath(); ctx.moveTo((x+1)*g+.5,(1)*g); ctx.lineTo((x+1)*g+.5,(state.rows+1)*g); ctx.stroke(); }
    for(let y=0;y<=state.rows;y++){ ctx.beginPath(); ctx.moveTo((1)*g,(y+1)*g+.5); ctx.lineTo((state.cols+1)*g,(y+1)*g+.5); ctx.stroke(); }
    state.items.forEach(drawItem);
    const rx = state.prevHen.x + (state.hen.x - state.prevHen.x) * interp;
    const ry = state.prevHen.y + (state.hen.y - state.prevHen.y) * interp;
    const x=(rx+1)*g, y=(ry+1)*g;
    ctx.drawImage(henImg,x-12,y-16,24,24);
  }

  function loop(ts){
    if(!state.running){ return; }
    const dt = Math.min(50,(ts - state.last)/1000); state.last = ts;
    state.mover += state.speed * dt;
    while(state.mover >= 1){ if(!advanceCell()) return; state.mover -= 1; }
    const interp = state.mover;
    draw(interp);
    requestAnimationFrame(loop);
  }

  function gameOver(){
    state.running=false;
    document.getElementById('fScore').textContent = state.score;
    document.getElementById('fHi').textContent = state.hi;
    document.getElementById('over').style.display='flex';
  }

  function startGame(){
    document.getElementById('startFS').style.display='none';
    document.getElementById('over').style.display='none';
    reset(); fit(); state.running=true; state.last=performance.now(); requestAnimationFrame(loop);
  }

  // UI wiring
  document.getElementById('playBtn').addEventListener('click', ()=>{
    // start music only on user gesture
    if(soundOn){
      try{ music.muted=false; music.currentTime=0; music.play(); }catch(e){}
    }
    startGame();
  }, {passive:true});

  document.getElementById('again').addEventListener('click', ()=>{ startGame(); }, {passive:true});
  document.getElementById('menu').addEventListener('click', ()=>{
    document.getElementById('over').style.display='none';
    document.getElementById('startFS').style.display='flex';
  }, {passive:true});

  document.getElementById('soundBtn').addEventListener('click', ()=>{
    soundOn = !soundOn;
    if(!soundOn) { music.pause(); }
    else { music.play().catch(()=>{}); }
    document.getElementById('soundBtn').textContent = soundOn ? 'üîä' : 'üîá';
  });

  document.getElementById('restartBtn').addEventListener('click', ()=> startGame(), {passive:true});

  // Pad & keys
  document.getElementById('pad').addEventListener('pointerdown', (e)=>{
    const t=e.target.closest('button[data-d]'); if(!t) return;
    const [dx,dy]=t.getAttribute('data-d').split(',').map(Number);
    setDir(dx,dy);
  }, {passive:true});
  window.addEventListener('keydown',(e)=>{
    if(e.key==='ArrowUp'||e.key==='w') setDir(0,-1);
    else if(e.key==='ArrowDown'||e.key==='s') setDir(0,1);
    else if(e.key==='ArrowLeft'||e.key==='a') setDir(-1,0);
    else if(e.key==='ArrowRight'||e.key==='d') setDir(1,0);
  });

  // Resize
  function onResize(){ fit(); draw(0); }
  new ResizeObserver(onResize).observe(playArea);
  window.addEventListener('orientationchange', ()=> setTimeout(onResize,0));

  // init: show start screen
  fit(); draw(0);
})();
</script>
</body>
</html>
